name: Container Image CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  container:
    name: build fedora-dev container
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Build container
        run: |
          podman build \
          --squash \
          --file=Containerfile \
          --tag=$GITHUB_REPOSITORY:$GITHUB_SHA \
          $GITHUB_WORKSPACE
      - name: Login to ghcr.io
        run: |
          podman logout --all
          podman login --username $GITHUB_ACTOR --password ${{secrets.GITHUB_TOKEN}} ghcr.io
      - name: Push container
        run: |
          podman image ls
          podman container ls --all --size
          echo podman push $GITHUB_REPOSITORY:$GITHUB_SHA ghcr.io/${{ github.repository }}:latest
          podman push $GITHUB_REPOSITORY:$GITHUB_SHA ghcr.io/${{ github.repository }}:latest
          podman push $GITHUB_REPOSITORY:$GITHUB_SHA ghcr.io/${{ github.repository }}:$COMMIT_SHA
